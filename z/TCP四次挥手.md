---
tags:
  - tech/dev/network
  - type/concept
  - status/seed
description: TCP四次挥手
created: 2025-01-01T00:00:00
updated: 2025-12-07T21:16:37
---

> [!info] **上级索引**
> [[计算机网络 MOC]] | [[前端基础 MOC]]

---


# TCP 四次挥手详解

## 一、四次挥手流程（以客户端主动关闭为例）
| 步骤       | 发送方 | 报文类型       | 状态变化                | 关键说明                     |
|------------|--------|----------------|-------------------------|------------------------------|
| 第一次挥手 | 客户端 | `FIN` (Seq=u)  | `ESTABLISHED` → `FIN_WAIT_1` | 客户端不再发送数据，但可接收 |
| 第二次挥手 | 服务端 | `ACK` (Ack=u+1)| `CLOSE_WAIT`            | 服务端可能仍有数据待发送     |
| 第三次挥手 | 服务端 | `FIN` (Seq=w)  | `CLOSE_WAIT` → `LAST_ACK` | 服务端数据发送完毕           |
| 第四次挥手 | 客户端 | `ACK` (Ack=w+1)| `FIN_WAIT_2` → `TIME_WAIT` | 客户端等待 2MSL 后关闭连接    |

> **注意**：  
> - 主动关闭方会进入 `TIME_WAIT` 状态，被动关闭方直接进入 `CLOSED` 状态。  
> - 实际抓包中第一次挥手可能是 `FIN+ACK`（因 TCP 头部 ACK 字段默认有效）。

## 二、为什么需要四次挥手？
1. **全双工特性**：TCP 连接双向独立关闭，服务端需等待数据发送完毕后再发送 `FIN`。  
2. **可靠性保证**：若合并第二次和第三次挥手（`ACK` + `FIN`），可能导致客户端误判 `FIN` 丢失而重复重传。

## 三、关键状态解析
### 1. `TIME_WAIT`（2MSL 等待）
- **作用**：  
  - 确保最后一个 `ACK` 到达服务端（若丢失，服务端会重传 `FIN`）。  
  - 消除网络中残留的旧报文，避免干扰新连接。  
- **默认时长**：Linux 中为 60 秒（2×MSL），可通过 `tcp_fin_timeout` 调整。

### 2. `CLOSE_WAIT`
- **触发条件**：被动关闭方收到 `FIN` 但未调用 `close()`。  
- **风险**：若程序未及时关闭连接，会导致连接长期滞留（理论无限长）。

## 四、异常处理
| 挥手丢失步骤 | 处理机制                                                                 | 重传控制参数          |
|--------------|--------------------------------------------------------------------------|-----------------------|
| 第一次挥手   | 客户端重传 `FIN`，超时后直接关闭                                         | `tcp_orphan_retries` |
| 第二次挥手   | 客户端重传 `FIN`（服务端 `ACK` 不重传）                                  | `tcp_orphan_retries` |
| 第三次挥手   | 服务端重传 `FIN`，客户端在 `FIN_WAIT_2` 状态超时（默认 60 秒）后关闭     | `tcp_fin_timeout`    |
| 第四次挥手   | 服务端重传 `FIN`，客户端在 `TIME_WAIT` 状态持续 2MSL 后关闭              | -                     |

> **注**：若程序崩溃，系统会强制发送 `RST` 终止连接。

## 五、优化建议
1. **减少 `TIME_WAIT`**：  
   - 启用 `net.ipv4.tcp_tw_reuse`（需时间戳支持）。  
   - 避免短连接高并发场景（如改用长连接）。  
2. **排查 `CLOSE_WAIT`**：检查代码是否漏调 `close()` 或存在阻塞。

---


