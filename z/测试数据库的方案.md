---
tags:
  - tech/lang/testing
  - type/howto
  - status/growing
description: 测试环境数据库隔离方案与最佳实践
created: 2025-01-01T00:00:00
updated: 2025-12-07T21:16:36
---

> [!info] **上级索引**
> [[测试 MOC]] | [[数据库 MOC]]

---

Summarized conversation history我来详细解释一下为什么测试需要独立的数据库，以及直接使用开发数据库会有什么问题。

你先帮我统一一下测试工具，搞一个测试系统，同样在 web 端的 e2e、等测试 和 api 的测试 中方便地测试。是放在 packages/ utils 中呢，还是哪里，请你想一个最佳实践；或者先讨论有没有必要搞一个统一测试工具

## 🎯 为什么不能用开发数据库进行测试？

### ❌ 使用开发数据库的严重问题

#### 1. **数据会被清空和污染**
```typescript
// 测试代码中经常需要清空数据
beforeEach(async () => {
  await cleanDatabase(); // ⚠️ 会删除开发数据库中的所有数据！
});
```
- 每次测试前都会执行 `TRUNCATE CASCADE`，**清空所有表**
- 你正在开发调试的数据会被删除
- 多人协作时，你的测试会删除其他人的数据

#### 2. **并发冲突**
```typescript
// 开发时你在创建用户
POST /api/accounts { username: "test" }

// 同时测试也在创建
test('should create account', async () => {
  await createAccount({ username: "test" }); // ❌ 唯一键冲突！
});
```

#### 3. **测试不可靠**
```typescript
test('should have 3 goals', async () => {
  const goals = await goalRepository.findAll();
  expect(goals).toHaveLength(3); // ❌ 可能是 5 个，因为你手动创建了 2 个
});
```

#### 4. **无法回滚**
```typescript
test('should delete account cascade', async () => {
  await accountRepository.delete(accountId);
  // ⚠️ 你的开发账号被删除了，且无法恢复！
});
```

---

## ✅ 正确的数据库方案对比

### 方案 1: 独立测试数据库（推荐）⭐

```yaml
# docker-compose.test.yml
services:
  test-db:
    image: postgres:15-alpine
    ports:
      - "5433:5432"  # 不同的端口！
    environment:
      POSTGRES_DB: dailyuse_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_pass
```

**优点**：
- ✅ **完全隔离**：测试和开发互不影响
- ✅ **可重复**：每次测试前清空数据，保证一致性
- ✅ **快速**：使用 tmpfs（内存文件系统），读写速度提升 10 倍
- ✅ **安全**：测试数据随意删除，不影响开发

**使用场景**：
```typescript
// 开发时连接 5432 端口
DATABASE_URL=postgresql://localhost:5432/dailyuse

// 测试时连接 5433 端口
DATABASE_URL=postgresql://localhost:5433/dailyuse_test
```

---

### 方案 2: 共享开发数据库（❌ 不推荐）

```typescript
// ⚠️ 危险操作
beforeEach(async () => {
  await prisma.goal.deleteMany(); // 删除所有目标
  await prisma.account.deleteMany(); // 删除所有账号
});
```

**问题**：
- ❌ **数据丢失**：你辛苦创建的测试数据被清空
- ❌ **冲突频繁**：ID、用户名、邮箱等唯一字段冲突
- ❌ **测试失败**：依赖数据不确定，测试结果不可靠
- ❌ **性能差**：开发数据库可能很大，清空很慢

---

### 方案 3: 事务回滚（部分场景可用）

```typescript
import { PrismaClient } from '@prisma/client';

let prisma: PrismaClient;
let txn: any;

beforeEach(async () => {
  prisma = new PrismaClient();
  txn = await prisma.$transaction(async (tx) => {
    // 测试在事务中执行
    return tx;
  });
});

afterEach(async () => {
  await txn.$rollback(); // 回滚事务
});
```

**优点**：
- ✅ 不需要额外数据库
- ✅ 测试后自动回滚，不污染数据

**缺点**：
- ❌ **无法测试事务逻辑**：你的业务代码也有事务，嵌套事务会失败
- ❌ **复杂度高**：需要改造所有 Repository 接受事务对象
- ❌ **不支持多进程**：Vitest 并发测试时无法共享事务

---

## 📊 性能对比 

Read [](file:///d%3A/myPrograms/DailyUse/docker-compose.test.yml)

| 方案 | 数据清理速度 | 写入速度 | 读取速度 | 隔离性 |
|------|------------|---------|---------|--------|
| **独立测试数据库 + tmpfs** | ⚡ 0.1s | ⚡⚡⚡ 极快 | ⚡⚡⚡ 极快 | ✅ 完全隔离 |
| 共享开发数据库 | 🐌 2-5s | 🐌 慢 | 🐌 慢 | ❌ 无隔离 |
| 事务回滚 | ⚡ 0.01s | 🐌 中等 | 🐌 中等 | ⚠️ 部分隔离 |

---

## 🛠️ 我们的配置解析

```yaml
# docker-compose.test.yml
tmpfs:
  - /var/lib/postgresql/data:rw  # ✅ 数据存储在内存中，极快！
  
command:
  - "fsync=off"              # ✅ 关闭磁盘同步，测试环境不需要持久化
  - "synchronous_commit=off" # ✅ 异步提交，提升写入速度
  - "full_page_writes=off"   # ✅ 关闭完整页写入
```

**性能提升**：
- 💾 **内存文件系统**：读写速度从 100MB/s → 5GB/s
- ⚡ **关闭持久化**：事务提交从 10ms → 0.1ms
- 🚀 **测试速度**：整体测试时间从 60s → 10s

---

## 🎯 最佳实践建议

### 推荐方案：独立测试数据库 + Docker Compose

```typescript
// apps/api/src/test/setup-database.ts
import { PrismaClient } from '@prisma/client';

let prisma: PrismaClient;

export async function setupTestDatabase() {
  // ✅ 连接测试数据库（5433 端口）
  prisma = new PrismaClient({
    datasources: {
      db: {
        url: 'postgresql://test_user:test_pass@localhost:5433/dailyuse_test'
      }
    }
  });
  
  await prisma.$connect();
  await cleanDatabase();
}

export async function cleanDatabase() {
  // ✅ 安全清空：只影响测试数据库
  await prisma.$executeRaw`TRUNCATE TABLE "account" CASCADE`;
  await prisma.$executeRaw`TRUNCATE TABLE "goal" CASCADE`;
  // ... 其他表
}
```

### 数据库端口分配

```bash
# 开发数据库
localhost:5432  → dailyuse (你的开发数据)

# 测试数据库  
localhost:5433  → dailyuse_test (测试时自动清空)

# 生产数据库
production-host:5432  → dailyuse_prod (生产数据)
```

---

## 💡 总结

**为什么不能用开发数据库？**

1. ⚠️ **会删除你的数据** - 测试前执行 `TRUNCATE CASCADE`
2. ⚠️ **测试不可靠** - 数据不确定，结果不可重复
3. ⚠️ **冲突频繁** - 唯一键、外键冲突
4. ⚠️ **性能差** - 开发数据库数据多，操作慢

**正确做法：**
- ✅ 使用独立测试数据库（Docker Compose，端口 5433）
- ✅ 配置 tmpfs 内存文件系统，极速读写
- ✅ 每次测试前清空数据，保证可重复性
- ✅ 测试结束后容器自动销毁，不留痕迹

**你现在需要做的：**
1. 安装 Docker Desktop（如果还没有）
2. 启动测试数据库：`docker compose -f docker-compose.test.yml up -d`
3. 运行测试：`pnpm nx test api`


